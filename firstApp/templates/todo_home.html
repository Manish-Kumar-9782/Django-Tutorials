<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9"
          crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
            crossorigin="anonymous"></script>
</head>

<body class="px-3 d-flex flex-column justify-content-center align-items-center">

    <div class="d-flex justify-content-end border p-4">
        {% if request.user.is_authenticated %}
        <span class="px-2">{{request.user.username}}</span>
        <button type="btn"
                class="btn btn-secondary">
            <a class="text-decoration-none text-light"
               href="{% url 'logout' %}">logout</a>
        </button>
        {% endif %}
    </div>

    <h1>Todo App</h1>

    <div class="todo-container mt-3">
        <form action="{% url 'add_todo' %}"
              method="POST">

            {% csrf_token %}

            <div class="d-flex gap-2">

                <input type="text"
                       class="form-control"
                       name="content">

                <input type="submit"
                       value="Add Item"
                       class="btn btn-success">
            </div>
        </form>

    </div>

    <div class="todo-list-items border mt-4 border-primary w-75">
        <ul id="todo-items"
            class="list-group">
            {% for item in todo_items %}
            <li class="list-group-item m-2 shadow">

                <span class="{% if item.isCompleted %}
                text-decoration-line-through
                {% endif %}
                ">
                    <input type="checkbox"
                           data-id={{item.id}}
                           {% if item.isCompleted %}
                           checked
                           {% endif %}>

                    {{item.content}}</span>

                <span><button type="button"
                            class="btn btn-primary btn-sm"><a
                           class="text-decoration-none text-light"
                           href="{% url 'update_todo' item.id %}">edit</a></button></span>

                <span><button type="button"
                            class="btn btn-danger btn-sm"><a class="text-decoration-none text-light"
                           href="{% url 'delete_todo' item.id %}">delete</a></button></span>
            </li>

            {% endfor %}
        </ul>
    </div>

    <form action="{% url 'update_todo' 0 %}"
          id="update-todo"
          method="POST"
          hidden>
        {% csrf_token %}
        <input type="text"
               name="isCompleted">
        <input type="text"
               name="id">
    </form>

    <script>
        const todo_items_check = document.querySelectorAll("#todo-items li input[type=checkbox]");

        todo_items_check.forEach((item) => {
            item.addEventListener("change",
                () => {
                    // first change the url
                    const form = document.forms["update-todo"]

                    // only accessing the parent url without any id.
                    let url = form.action.substr(0, form.action.lastIndexOf("/"))

                    // adding id number of the item to the parent url.
                    url += "/" + item.dataset.id;

                    form.action = url;

                    // filling the form dynamically
                    form["isCompleted"].value = item.checked;
                    form["id"].value = item.dataset.id;

                    form.submit();
                }
            )
        })
    </script>

</body>

</html>